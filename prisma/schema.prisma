// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
    provider = "prisma-client-js"
}

datasource db {
    provider = "mongodb"
    url      = env("DATABASE_URL")
}

model User {
    id           String  @id @map("_id")
    emailAddress String  @unique
    firstName    String?
    lastName     String?
    imageUrl     String?

    role Role @default(user)

    accounts Account[]

    chatbotInteraction ChatbotInteraction?
}

enum Role {
    user
    admin
}

model ChatbotInteraction {
    id String @id @default(auto()) @map("_id") @db.ObjectId

    day   String
    count Int    @default(1)

    userId String? @unique
    user   User?   @relation(fields: [userId], references: [id])
}

model Account {
    id     String @id @default(auto()) @map("_id") @db.ObjectId
    userId String

    binaryIndex Json?

    token        String @unique
    provider     String
    emailAddress String
    name         String

    nextDeltaToken String?

    user           User           @relation(fields: [userId], references: [id])
    threads        Thread[]
    emailAddresses EmailAddress[]
}

model Thread {
    id              String   @id @default(auto()) @map("_id") @db.ObjectId
    subject         String
    lastMessageDate DateTime
    participantIds  String[]
    accountId       String   @db.ObjectId
    account         Account  @relation(fields: [accountId], references: [id])

    done Boolean @default(false)

    inboxStatus Boolean @default(true)
    draftStatus Boolean @default(false)
    sentStatus  Boolean @default(false)

    emails Email[]

    @@index([accountId])
    @@index([done])
    @@index([inboxStatus])
    @@index([draftStatus])
    @@index([sentStatus])
    @@index([lastMessageDate])
}

model Email {
    id                   String                @id @default(auto()) @map("_id") @db.ObjectId
    threadId             String                @db.ObjectId
    thread               Thread                @relation(fields: [threadId], references: [id])
    createdTime          DateTime
    lastModifiedTime     DateTime
    sentAt               DateTime
    receivedAt           DateTime
    internetMessageId    String
    subject              String
    sysLabels            String[]
    keywords             String[]
    sysClassifications   String[]
    sensitivity          Sensitivity           @default(normal)
    meetingMessageMethod MeetingMessageMethod?
    
    from                 EmailAddressEmbed
    toIds                String[]              @db.ObjectId
    ccIds                String[]              @db.ObjectId
    bccIds               String[]              @db.ObjectId
    replyToIds           String[]              @db.ObjectId
    
    hasAttachments       Boolean
    body                 String?
    bodySnippet          String?
    attachments          EmailAttachment[]
    inReplyTo            String?
    references           String?
    threadIndex          String?
    internetHeaders      Json[]
    nativeProperties     Json?
    folderId             String?
    omitted              String[]

    emailLabel EmailLabel @default(inbox)

    @@index([threadId])
    @@index([emailLabel])
    @@index([sentAt])
}

type EmailAddressEmbed {
    name    String?
    address String
    raw     String?
}

enum EmailLabel {
    inbox
    sent
    draft
}

model EmailAddress {
    id        String  @id @default(auto()) @map("_id") @db.ObjectId
    name      String?
    address   String
    raw       String?

    accountId String  @db.ObjectId
    account   Account @relation(fields: [accountId], references: [id])

    @@unique([accountId, address])
}

model EmailAttachment {
    id              String  @id @default(auto()) @map("_id") @db.ObjectId
    name            String
    mimeType        String
    size            Int
    inline          Boolean
    contentId       String?
    content         String?
    contentLocation String?
    emailId         String  @db.ObjectId
    email           Email   @relation(fields: [emailId], references: [id])

    @@index([emailId])
}

enum Sensitivity {
    normal
    private
    personal
    confidential
}

enum MeetingMessageMethod {
    request
    reply
    cancel
    counter
    other
}
